name: MSBuild MapWinGIS+Gdal3
on:
  push:
    branches:
      - feature/GDAL3-VS2019
    paths-ignore:
      - '**.md'
      #- '**.yml'
      - 'docs/**'
  pull_request:
    paths-ignore:
      - '**.md'
      - '**.yml'
      - 'docs/**'
env:
  # Path to the solution file relative to the root of the project.
  SUPPORTLIBS_SOLUTION_FILE_PATH: ./Support/SupportLibs.sln
  MAPWINGIS_SOLUTION_FILE_PATH: ./src/MapWinGIS.sln
  UNITTESTS_SOLUTION_FILE_PATH: ./unittest-net6/unittest-net6.sln

  # Configuration type to build.
  # You can convert this to a build matrix if you need coverage of multiple configuration types.
  # https://docs.github.com/actions/learn-github-actions/managing-complex-workflows#using-a-build-matrix
  BUILD_CONFIGURATION: Release
  BUILD_PLATFORM: Win32
  
  #TODO: make runtime variable
  # TODO: Create installer using innosetup   
  # TODO: Publish installer to GitHub Releases

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1.0.2

    # Download GisInternals zips
    - name: Download GisInternals zips
      uses: Azure/powershell@v1
      with:
        # Specify the Az PowerShell script here.
        inlineScript: |
          Invoke-WebRequest -Uri "https://github.com/MapWindow/Dependencies/raw/main/GisInternals/release-1928-gdal-3.zip" -OutFile ".\Support\release-1928-gdal-3.zip"
          Invoke-WebRequest -Uri "https://github.com/MapWindow/Dependencies/raw/main/GisInternals/release-1928-gdal-3-libs.zip" -OutFile ".\Support\release-1928-gdal-3-libs.zip"
          Invoke-WebRequest -Uri "https://github.com/MapWindow/Dependencies/raw/main/GisInternals/release-1928-x64-gdal-3.zip" -OutFile ".\Support\release-1928-x64-gdal-3.zip"
          Invoke-WebRequest -Uri "https://github.com/MapWindow/Dependencies/raw/main/GisInternals/release-1928-x64-gdal-3-libs.zip" -OutFile ".\Support\release-1928-x64-gdal-3-libs.zip"
          ls .\Support\
        # Azure PS version to be used to execute the script, example: 1.8.0, 2.8.0, 3.4.0. To use the latest version, specify "latest".
        azPSVersion: "latest"
        # Select the value of the ErrorActionPreference variable for executing the script. Options: stop, continue, silentlyContinue. Default is Stop.
        errorActionPreference: Stop
        # If this is true, this task will fail if any errors are written to the error pipeline, or if any data is written to the Standard Error stream.
        failOnStandardError: true
    
    # Unzip zips by calling powershell script
    - name: Unzip
      working-directory: ./Support/
      shell: pwsh
      run: .\unpackVS2019GISInternals.ps1
             
    - name: Build SupportLibs
      working-directory: ${{env.GITHUB_WORKSPACE}}
      # Add additional options to the MSBuild command line here (like platform or verbosity level).
      # See https://docs.microsoft.com/visualstudio/msbuild/msbuild-command-line-reference
      # MSBuild SupportLibs.sln /t:Rebuild /p:Configuration=Release /p:Platform="Win32"
      run: msbuild /m /p:Configuration=${{env.BUILD_CONFIGURATION}} /p:Platform=${{env.BUILD_PLATFORM}} ${{env.SUPPORTLIBS_SOLUTION_FILE_PATH}}
        
    - name: Build MapWinGIS
      working-directory: ${{env.GITHUB_WORKSPACE}}
      # Add additional options to the MSBuild command line here (like platform or verbosity level).
      # See https://docs.microsoft.com/visualstudio/msbuild/msbuild-command-line-reference
      # MSBuild SupportLibs.sln /t:Rebuild /p:Configuration=Release /p:Platform="Win32"
      run: msbuild /m /p:Configuration=${{env.BUILD_CONFIGURATION}} /p:Platform=${{env.BUILD_PLATFORM}} ${{env.MAPWINGIS_SOLUTION_FILE_PATH}}
            
    - name: Unit Testing
      run: dotnet test ${{UNITTESTS_SOLUTION_FILE_PATH}} --runtime x86
